<!--
    ==========================================================================
    Alerts Page
    --------------------------------------------------------------------------
    - Display live alerts as they are received
    - Does not contain historical data
    - Alerts may come from a service or a plugin
    ==========================================================================
-->

{% extends "base.html" %}

<!--
    ==========================================================================
    CSS Styles
    --------------------------------------------------------------------------
    mainoverride.css:
        - Override the default W3.CSS styles to make the page full width
        - This is necessary to ensure the table fits the screen width

    logtable.css:
        - Custom styles for the alert log table
        - Ensures the table is responsive and looks good on all devices
    ==========================================================================
-->
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mainoverride.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/logtable.css') }}">
{% endblock %}

{% block content %}

<!--
    ==========================================================================
    Scripts
    --------------------------------------------------------------------------
    autorefresh.js:
        - Adds a box to refresh the page automatically
    
    sorttable.js:
        - Enabled sorting of the table by clicking on the column headers

    paginate.js:
        - Adds pagination functionality to the table
    ==========================================================================
-->
<script src="{{ url_for('static', filename='js/autorefresh.js') }}"></script>
<script src="{{ url_for('static', filename='js/sorttable.js') }}"></script>
<script src="{{ url_for('static', filename='js/paginate.js') }}"></script>


<!--
    ==========================================================================
    Page Header
    --------------------------------------------------------------------------
    - Title: "Live Alerts"
    - Refresh button: reloads the page to get the latest alerts
    - Auto-refresh toggle: allows users to enable or disable auto-refresh
    - A toolbar with summary, pagination, and filtering options
    ==========================================================================
-->
<div class="w3-container w3-responsive w3-padding-16" style="width:90vw; max-width:1600px; margin:0 auto;">
    <!-- Header with title and controls -->
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <!-- Left spacer -->
        <div style="flex:1;"></div>
        <!-- Centered Title -->
        <div style="flex:1; text-align: center;">
            <h1 style="margin: 0;">Live Alerts</h1>
        </div>
        <!-- Right controls -->
        <div class="w3-padding" style="flex:1; display: flex; align-items: center; justify-content: flex-end; gap: 12px;">
            <i class="fa fa-refresh"
            style="color:green; font-size:24px; cursor:pointer;"
            onclick="location.reload();"
            title="Refresh"></i>
            <label style="display: flex; align-items: center; font-size: 15px; margin-left: 12px;">
                <input type="checkbox" id="autoRefreshToggle" style="margin-right: 12px;">
                Auto-refresh
            </label>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="w3-padding" style="display: flex; align-items: center; justify-content: space-between;">
        <!-- Simple filtering controls -->
        <div style="display: flex; align-items: center; gap: 16px;">
            <!-- Seach bar -->
            <form method="get" style="display: inline;" id="searchForm">
                <input type="text" name="search" placeholder="Search messages..." value="{{ request.args.get('search', '') }}" style="padding: 4px 8px;"/>
                <button type="submit" class="w3-button w3-blue w3-round w3-small" style="margin-left: 4px;">
                    <i class="fa fa-search" aria-hidden="true"></i> Search
                </button>
                {% if request.args.get('system_only') %}
                    <input type="hidden" name="system_only" value="1">
                {% endif %}
            </form>

            <!-- System log filter -->
            <form method="get" style="display: inline;" id="systemLogsForm">
                <label style="margin-left: 12px; font-size: 15px;">
                    <input type="checkbox" name="system_only" value="1" {% if request.args.get('system_only') %}checked{% endif %} onchange="this.form.submit()">
                    System logs only
                </label>
            </form>
        </div>

        <!-- Summary and pagination -->
        <div style="display: flex; align-items: center; gap: 16px;">
            <!-- Alert count -->
            <span style="font-size: 18px; color: #333;">
                Showing {{ alerts|length }} of {{ total_logs }} events.
            </span>

            <!-- Pagination controls -->
            <button onclick="goToPage('{{ page - 1 }}')" {% if page <= 1 %}disabled{% endif %} title="Previous page">
                <i class="fa fa-chevron-left"></i>
            </button>
            <span style="margin: 0 8px;">Page {{ page }} of {{ total_pages }}</span>
            <button onclick="goToPage('{{ page + 1 }}')" {% if page >= total_pages %}disabled{% endif %} title="Next page">
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!--
    ==========================================================================
    Table of alert entries
    --------------------------------------------------------------------------
    - Date and Time
    - Source (service or plugins name)
    - Alert message
    ==========================================================================
-->
<div class="w3-container w3-responsive w3-padding-16" style="width:90vw; max-width:1600px; margin:0 auto; overflow-x:auto;">
    <table class="w3-table w3-striped" style="table-layout: auto; width: 100%;">
        <thead>
            <tr>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(0)">Time &#x25B2;&#x25BC;</th>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(1)">Source &#x25B2;&#x25BC;</th>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(2)">Group &#x25B2;&#x25BC;</th>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(3)">Category &#x25B2;&#x25BC;</th>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(4)">Alert &#x25B2;&#x25BC;</th>
                <th style="white-space:nowrap; cursor:pointer;" onclick="sortTable(5)">Severity &#x25B2;&#x25BC;</th>
                <th style="cursor:pointer;" onclick="sortTable(6)">Message &#x25B2;&#x25BC;</th>
            </tr>
        </thead>
        <tbody>
        {% for alert in alerts %}
            <tr>
                <td style="white-space:nowrap;">{{ alert[0] }}</td>
                <td style="white-space:nowrap;">{{ alert[1] }}</td>
                <td style="white-space:nowrap;">{{ alert[2] }}</td>
                <td style="white-space:nowrap;">{{ alert[3] }}</td>
                <td style="white-space:nowrap;">{{ alert[4] }}</td>
                <td style="white-space:nowrap;">{{ alert[5] }}</td>
                <td style="white-space:normal; overflow-wrap:break-word; word-break:break-all;">{{ alert[6] }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}